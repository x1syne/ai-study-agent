# Архитектура AI Study Agent

## Общая схема работы приложения

```
┌─────────────────────────────────────────────────────────────────┐
│                         ПОЛЬЗОВАТЕЛЬ                            │
│              Нажимает "Создать курс" → вводит тему              │
│                    Например: "Python ООП"                       │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      FRONTEND (Next.js)                         │
│                                                                 │
│  app/(dashboard)/goals/new/page.tsx                            │
│  - Форма ввода темы курса                                       │
│  - Отправляет POST запрос на /api/goals                        │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      API ROUTE (Backend)                        │
│                                                                 │
│  app/api/goals/route.ts                                        │
│  - Получает тему от пользователя                               │
│  - Запускает AI-агент для генерации структуры курса            │
│  - Сохраняет результат в базу данных                           │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
```

---

## Этап 1: RAG — Сбор контекста из внешних источников

```
┌─────────────────────────────────────────────────────────────────┐
│                    RAG SEARCH (lib/search.ts)                   │
│                                                                 │
│  Параллельные запросы к внешним API:                           │
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │  Wikipedia  │  │  DuckDuckGo │  │   Serper    │             │
│  │  (бесплатно)│  │  (бесплатно)│  │(Google API) │             │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘             │
│         │                │                │                     │
│         └────────────────┼────────────────┘                     │
│                          ▼                                      │
│              Объединённый контекст для LLM                      │
│         (актуальная информация по теме курса)                   │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
```

---

## Этап 2: AI-Агент — Трёхэтапная генерация

```
┌─────────────────────────────────────────────────────────────────┐
│              AI AGENT SYSTEM (lib/ai/agent.ts)                  │
│                                                                 │
│  ╔═══════════════════════════════════════════════════════════╗ │
│  ║  ЭТАП 1: AI-АНАЛИТИК (analyzeTopicDeep)                   ║ │
│  ║                                                           ║ │
│  ║  Отправляет промпт в LLM:                                 ║ │
│  ║  "Проанализируй тему Python ООП..."                       ║ │
│  ║                                                           ║ │
│  ║  LLM возвращает JSON:                                     ║ │
│  ║  {                                                        ║ │
│  ║    "nature": ["procedural", "conceptual"],                ║ │
│  ║    "complexity": { "base": 6, "depth": 8 },               ║ │
│  ║    "learningMethods": ["theory-practice-project"],        ║ │
│  ║    "contentFormats": ["code_examples", "practice_tasks"], ║ │
│  ║    "keyTerms": ["класс", "объект", "наследование"...]     ║ │
│  ║  }                                                        ║ │
│  ╚═══════════════════════════════════════════════════════════╝ │
│                              │                                  │
│                              ▼                                  │
│  ╔═══════════════════════════════════════════════════════════╗ │
│  ║  ЭТАП 2: КОНСТРУКТОР (buildCourseStructure)               ║ │
│  ║                                                           ║ │
│  ║  На основе анализа строит структуру:                      ║ │
│  ║  - Если complexity > 6 → добавляет "Интуитивное понимание"║ │
│  ║  - Если nature = "procedural" → добавляет практику        ║ │
│  ║  - Если есть code_examples → добавляет примеры кода       ║ │
│  ║                                                           ║ │
│  ║  Результат: список секций курса                           ║ │
│  ╚═══════════════════════════════════════════════════════════╝ │
│                              │                                  │
│                              ▼                                  │
│  ╔═══════════════════════════════════════════════════════════╗ │
│  ║  ЭТАП 3: ГЕНЕРАТОР (generateFullLessonContent)            ║ │
│  ║                                                           ║ │
│  ║  Для каждой секции:                                       ║ │
│  ║  1. Формирует промпт под тип секции                       ║ │
│  ║  2. Отправляет в LLM                                      ║ │
│  ║  3. Ждёт 1.5 сек (чтобы не превысить rate limit)         ║ │
│  ║  4. Собирает весь контент в один урок                     ║ │
│  ╚═══════════════════════════════════════════════════════════╝ │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
```

---

## Этап 3: AI Router — Выбор нейросети

```
┌─────────────────────────────────────────────────────────────────┐
│                 AI ROUTER (lib/ai-router.ts)                    │
│                                                                 │
│  Запрос от AI-агента                                           │
│         │                                                       │
│         ▼                                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Определение типа задачи:                               │   │
│  │                                                         │   │
│  │  • fast (быстрые) → чат, простые вопросы               │   │
│  │  • heavy (тяжёлые) → генерация курсов, уроков          │   │
│  │  • chat → диалог с AI-репетитором                      │   │
│  └─────────────────────────────────────────────────────────┘   │
│         │                                                       │
│         ▼                                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Выбор провайдера по стратегии:                         │   │
│  │                                                         │   │
│  │  fast:  Groq ──────► Gemini                            │   │
│  │                                                         │   │
│  │  heavy: DeepSeek ──► Gemini ──► Groq                   │   │
│  │                                                         │   │
│  │  chat:  Groq (только он, для скорости)                 │   │
│  └─────────────────────────────────────────────────────────┘   │
│         │                                                       │
│         ▼                                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Проверка rate limit:                                   │   │
│  │                                                         │   │
│  │  Groq:     30 запросов/минуту                          │   │
│  │  DeepSeek: 60 запросов/минуту                          │   │
│  │  Gemini:   50 запросов/минуту                          │   │
│  │                                                         │   │
│  │  Если лимит превышен → переключение на следующий       │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
```

---

## Этап 4: Запрос к LLM (нейросети)

```
┌─────────────────────────────────────────────────────────────────┐
│                    GROQ API (lib/groq.ts)                       │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Каскад моделей (если одна не работает → следующая):    │   │
│  │                                                         │   │
│  │  1. LLaMA 3.3-70B Versatile (основная, 70 млрд парам.) │   │
│  │         │                                               │   │
│  │         ▼ (rate limit или ошибка)                       │   │
│  │  2. LLaMA 3.1-70B Versatile (запасная)                 │   │
│  │         │                                               │   │
│  │         ▼ (ошибка)                                      │   │
│  │  3. LLaMA 3.1-8B Instant (быстрая, 8 млрд параметров)  │   │
│  │         │                                               │   │
│  │         ▼ (ошибка)                                      │   │
│  │  4. Mixtral 8x7B-32768 (альтернатива от Mistral)       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Прокси для России (если USE_PROXY=true):               │   │
│  │                                                         │   │
│  │  Клиент ──► Supabase Edge Function ──► Groq API        │   │
│  │                                                         │   │
│  │  (Groq заблокирован в РФ, прокси обходит блокировку)   │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
```

---

## Этап 5: Сохранение в базу данных

```
┌─────────────────────────────────────────────────────────────────┐
│              PRISMA ORM + PostgreSQL (Supabase)                 │
│                                                                 │
│  Сохраняются:                                                   │
│                                                                 │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐       │
│  │    Goal     │────►│   Topics    │────►│   Lessons   │       │
│  │   (курс)    │ 1:N │   (темы)    │ 1:N │   (уроки)   │       │
│  └─────────────┘     └─────────────┘     └─────────────┘       │
│                                                                 │
│  Goal:                                                          │
│  - id, userId, title, skill, status                            │
│                                                                 │
│  Topic:                                                         │
│  - id, goalId, name, description, difficulty, order            │
│  - prerequisiteIds (зависимости между темами)                  │
│                                                                 │
│  Lesson:                                                        │
│  - id, topicId, type (THEORY/PRACTICE), content (JSON)         │
└─────────────────────────────────────────────────────────────────┘
```

---

## Полная схема: от клика до результата

```
ПОЛЬЗОВАТЕЛЬ
     │
     │ 1. Нажимает "Создать курс", вводит "Python ООП"
     ▼
┌─────────────────────────────────────────────────────────────────┐
│ FRONTEND: app/(dashboard)/goals/new/page.tsx                   │
│                                                                 │
│ fetch('/api/goals', { method: 'POST', body: { title: '...' }}) │
└─────────────────────────────┬───────────────────────────────────┘
                              │
     │ 2. POST /api/goals
     ▼
┌─────────────────────────────────────────────────────────────────┐
│ API: app/api/goals/route.ts                                    │
│                                                                 │
│ async function POST(req) {                                      │
│   const { title } = await req.json()                           │
│   const ragContext = await getRAGContext(title)  // ◄── RAG    │
│   const result = await runLessonAgent(title)     // ◄── AI     │
│   await prisma.goal.create({ data: result })     // ◄── DB     │
│ }                                                               │
└─────────────────────────────┬───────────────────────────────────┘
                              │
     │ 3. RAG: сбор контекста
     ▼
┌─────────────────────────────────────────────────────────────────┐
│ RAG: lib/search.ts                                             │
│                                                                 │
│ Promise.all([                                                   │
│   searchWikipedia("Python ООП"),      // Wikipedia API         │
│   searchDuckDuckGo("Python ООП"),     // DuckDuckGo API        │
│   searchSerper("Python ООП tutorial") // Google Search API     │
│ ])                                                              │
│                                                                 │
│ Результат: "ООП — парадигма программирования, основанная на..."│
└─────────────────────────────┬───────────────────────────────────┘
                              │
     │ 4. AI-Агент: анализ темы
     ▼
┌─────────────────────────────────────────────────────────────────┐
│ AGENT: lib/ai/agent.ts → analyzeTopicDeep()                    │
│                                                                 │
│ Промпт: "Проанализируй тему Python ООП..."                     │
│                                                                 │
│ ──────────────────────────────────────────────────────────────►│
│                         AI ROUTER                               │
│ ◄──────────────────────────────────────────────────────────────│
│                                                                 │
│ Ответ LLM (JSON):                                              │
│ {                                                               │
│   "nature": ["procedural", "conceptual"],                      │
│   "complexity": { "base": 6 },                                 │
│   "contentFormats": ["code_examples"]                          │
│ }                                                               │
└─────────────────────────────┬───────────────────────────────────┘
                              │
     │ 5. AI Router: выбор нейросети
     ▼
┌─────────────────────────────────────────────────────────────────┐
│ ROUTER: lib/ai-router.ts                                       │
│                                                                 │
│ taskType = "heavy" (генерация курса — тяжёлая задача)          │
│                                                                 │
│ Стратегия: DeepSeek → Gemini → Groq                            │
│                                                                 │
│ 1. Пробуем DeepSeek...                                         │
│    ├─ Есть API ключ? ✓                                         │
│    ├─ Rate limit OK? ✓                                         │
│    └─ Отправляем запрос ──────────────────────────────────────►│
│                                                                 │
│ 2. Если DeepSeek упал → пробуем Gemini                         │
│ 3. Если Gemini упал → пробуем Groq                             │
└─────────────────────────────┬───────────────────────────────────┘
                              │
     │ 6. Запрос к LLM
     ▼
┌─────────────────────────────────────────────────────────────────┐
│ LLM API (DeepSeek / Gemini / Groq)                             │
│                                                                 │
│ POST https://api.deepseek.com/chat/completions                 │
│ {                                                               │
│   "model": "deepseek-chat",                                    │
│   "messages": [                                                 │
│     { "role": "system", "content": "Ты аналитик..." },         │
│     { "role": "user", "content": "Проанализируй Python ООП" }  │
│   ],                                                            │
│   "temperature": 0.7,                                           │
│   "max_tokens": 4096                                            │
│ }                                                               │
│                                                                 │
│ Ответ: { "choices": [{ "message": { "content": "..." }}] }     │
└─────────────────────────────┬───────────────────────────────────┘
                              │
     │ 7. Генерация контента (секция за секцией)
     ▼
┌─────────────────────────────────────────────────────────────────┐
│ AGENT: generateFullLessonContent()                             │
│                                                                 │
│ for (section of sections) {                                     │
│   content = await generateCompletion(prompt)  // Запрос к LLM  │
│   await delay(1500)  // Пауза 1.5 сек (rate limit)             │
│   contentParts.push(content)                                    │
│ }                                                               │
│                                                                 │
│ Секции:                                                         │
│ 1. Введение ──────────► LLM ──────────► "## Введение\n..."     │
│ 2. Основные понятия ──► LLM ──────────► "## Основные..."       │
│ 3. Как это работает ──► LLM ──────────► "## Как это..."        │
│ 4. Практика ──────────► LLM ──────────► "## Практика\n..."     │
│ 5. Итоги ─────────────► LLM ──────────► "## Итоги\n..."        │
└─────────────────────────────┬───────────────────────────────────┘
                              │
     │ 8. Сохранение в БД
     ▼
┌─────────────────────────────────────────────────────────────────┐
│ PRISMA: lib/prisma.ts                                          │
│                                                                 │
│ await prisma.goal.create({                                      │
│   data: {                                                       │
│     userId: "user_123",                                         │
│     title: "Python ООП",                                        │
│     topics: {                                                   │
│       create: [                                                 │
│         { name: "Классы и объекты", order: 1 },                │
│         { name: "Наследование", order: 2 },                    │
│         { name: "Полиморфизм", order: 3 },                     │
│         ...                                                     │
│       ]                                                         │
│     }                                                           │
│   }                                                             │
│ })                                                              │
└─────────────────────────────┬───────────────────────────────────┘
                              │
     │ 9. Ответ пользователю
     ▼
┌─────────────────────────────────────────────────────────────────┐
│ FRONTEND: Редирект на страницу курса                           │
│                                                                 │
│ router.push(`/goals/${goalId}`)                                │
│                                                                 │
│ Пользователь видит:                                             │
│ ┌─────────────────────────────────────────────────────────┐    │
│ │  📚 Python ООП                                          │    │
│ │                                                         │    │
│ │  ○ Классы и объекты                                    │    │
│ │  ○ Наследование                                        │    │
│ │  ○ Полиморфизм                                         │    │
│ │  ○ Инкапсуляция                                        │    │
│ │  ○ Абстракция                                          │    │
│ └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

---

## Используемые нейросети

### Основные LLM (Large Language Models)

| Провайдер | Модель | Параметры | Назначение | Стоимость |
|-----------|--------|-----------|------------|-----------|
| **Groq** | LLaMA 3.3-70B | 70 млрд | Основная генерация | Бесплатно (30 req/min) |
| **Groq** | LLaMA 3.1-8B | 8 млрд | Быстрый fallback | Бесплатно |
| **Groq** | Mixtral 8x7B | 47 млрд | Альтернатива | Бесплатно |
| **DeepSeek** | DeepSeek-V3 | 671 млрд | Тяжёлые задачи | $0.14/1M токенов |
| **Google** | Gemini 1.5 Flash | — | Fallback | Бесплатно (15 req/min) |

### Как работает LLaMA

```
┌─────────────────────────────────────────────────────────────────┐
│                    LLaMA 3.3-70B Versatile                      │
│                                                                 │
│  Архитектура: Transformer (decoder-only)                        │
│  Параметры: 70 миллиардов                                       │
│  Контекст: 128K токенов                                         │
│  Обучение: 15 триллионов токенов текста                        │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    ВХОДНОЙ ПРОМПТ                        │   │
│  │  "Проанализируй тему Python ООП и верни JSON..."        │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    ТОКЕНИЗАЦИЯ                           │   │
│  │  "Python" → [15496]                                     │   │
│  │  "ООП" → [128, 128, 128]                                │   │
│  │  ...                                                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              TRANSFORMER LAYERS (80 слоёв)               │   │
│  │                                                         │   │
│  │  Self-Attention → Feed-Forward → Normalization          │   │
│  │       ↓               ↓               ↓                 │   │
│  │  Self-Attention → Feed-Forward → Normalization          │   │
│  │       ↓               ↓               ↓                 │   │
│  │                    ... × 80                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                 ГЕНЕРАЦИЯ ТОКЕНОВ                        │   │
│  │                                                         │   │
│  │  Предсказывает следующий токен на основе вероятностей   │   │
│  │  temperature=0.7 → добавляет "креативность"             │   │
│  │                                                         │   │
│  │  [15496] → "Python"                                     │   │
│  │  [318] → " это"                                         │   │
│  │  [257] → " язык"                                        │   │
│  │  ...                                                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    ВЫХОДНОЙ ТЕКСТ                        │   │
│  │  { "nature": ["procedural"], "complexity": {...} }      │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### Почему Groq такой быстрый?

```
┌─────────────────────────────────────────────────────────────────┐
│                         GROQ LPU                                │
│              (Language Processing Unit)                         │
│                                                                 │
│  Обычный GPU:                                                   │
│  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐                              │
│  │ GPU │→│ GPU │→│ GPU │→│ GPU │  Последовательная обработка  │
│  └─────┘ └─────┘ └─────┘ └─────┘  ~50 токенов/сек             │
│                                                                 │
│  Groq LPU:                                                      │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  ████████████████████████████████████████████████████  │   │
│  │  Параллельная обработка всех слоёв одновременно        │   │
│  │  ~500 токенов/сек (в 10 раз быстрее!)                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  Секрет: специальный чип, оптимизированный под Transformer     │
└─────────────────────────────────────────────────────────────────┘
```

---

## Дополнительные компоненты

### Spaced Repetition (Интервальное повторение)

```
Алгоритм SM-2:

EF' = EF + (0.1 - (5 - q) × (0.08 + (5 - q) × 0.02))

где:
  EF  — фактор лёгкости (начальное 2.5)
  q   — качество ответа (0-5)

Интервалы:
  1-й раз: 1 день
  2-й раз: 6 дней
  3-й раз: interval × EF
```

### Геймификация

```
XP за действия:
  • Правильный ответ (easy):   10 XP
  • Правильный ответ (medium): 25 XP
  • Правильный ответ (hard):   50 XP
  • Завершение темы:          100 XP

Уровни:
  Level = floor(sqrt(totalXP / 100))
```

---

## Файловая структура

```
ai-study-agent/
├── app/
│   ├── api/
│   │   ├── goals/route.ts      ← API создания курса
│   │   ├── topics/[id]/        ← API уроков
│   │   └── chat/route.ts       ← AI-чат
│   └── (dashboard)/
│       ├── goals/new/          ← Страница создания курса
│       └── learn/[topicId]/    ← Страница урока
├── lib/
│   ├── ai/
│   │   ├── agent.ts            ← Трёхэтапный AI-агент
│   │   └── prompts.ts          ← Промпты для LLM
│   ├── ai-router.ts            ← Роутер между нейросетями
│   ├── groq.ts                 ← Интеграция Groq API
│   ├── search.ts               ← RAG (Wikipedia, DuckDuckGo)
│   ├── gamification.ts         ← XP, уровни, достижения
│   └── spaced-repetition.ts    ← Алгоритм SM-2
└── prisma/
    └── schema.prisma           ← Схема базы данных
```
