# AI Study Agent - Полная техническая документация

## 1. Стек технологий

### Frontend
| Технология | Версия | Назначение |
|------------|--------|------------|
| TypeScript | 5.x | Статическая типизация, надежность кода |
| Next.js | 14.x | React-фреймворк с App Router, SSR/SSG, API Routes |
| React | 18.x | Компонентная архитектура, хуки, состояние |
| Tailwind CSS | 3.x | Utility-first CSS, адаптивный дизайн |
| Lucide React | 0.294.0 | Библиотека иконок |

### Backend
| Технология | Назначение |
|------------|------------|
| Next.js API Routes | Серверные эндпоинты в `/app/api/` |
| Prisma ORM | Типобезопасная работа с PostgreSQL |
| PostgreSQL | Реляционная база данных |
| JWT | Аутентификация пользователей |

### AI/ML интеграции
| Сервис | Модели | Назначение |
|--------|--------|------------|
| Groq API | LLaMA 3.3-70B, LLaMA 3.1-70B, LLaMA 3.1-8B, Mixtral 8x7B | Генерация контента |
| Supabase Edge Functions | AI Proxy | Обход блокировок (для России) |

### Внешние API для обогащения контента
| API | Назначение |
|-----|------------|
| arXiv API | Научные статьи для технических тем |
| Open Library API | Книги и учебники |
| RAG (Retrieval-Augmented Generation) | Поиск релевантного контекста |

### Инфраструктура
| Сервис | Назначение |
|--------|------------|
| Vercel | Деплой, хостинг, Edge Functions |
| GitHub | Контроль версий |
| Supabase | База данных PostgreSQL, Edge Functions |

---

## 2. Архитектура AI-системы

### 2.1 Groq API Integration (`lib/groq.ts`)

Система использует каскадную модель с fallback:

```
Запрос → Supabase Proxy (если Россия) → Groq API
                ↓ (если ошибка)
        llama-3.3-70b-versatile (основная)
                ↓ (если rate limit)
        llama-3.1-70b-versatile (fallback 1)
                ↓ (если ошибка)
        llama-3.1-8b-instant (fallback 2)
                ↓ (если ошибка)
        mixtral-8x7b-32768 (fallback 3)
```

Параметры генерации:
- `temperature`: 0.4-0.8 (зависит от задачи)
- `maxTokens`: 2000-16000 (зависит от типа контента)
- `json`: true/false (для структурированных ответов)

### 2.2 AI Agent System (`lib/ai/agent.ts`)

Трёхэтапная архитектура генерации курсов:

#### Этап 1: AI-Аналитик
Анализирует тему и определяет:
- **Природа темы** (TopicNature):
  - `conceptual` — абстрактные идеи (квантовая физика, философия)
  - `procedural` — пошаговые процессы (программирование, рецепты)
  - `factual` — факты и даты (история, география)
  - `skill` — практические умения (музыка, спорт)
  - `creative` — творчество (рисование, писательство)

- **Метод обучения** (LearningMethod):
  - `theory-practice-project` — Теория → Практика → Проект
  - `examples-generalize-apply` — Примеры → Обобщение → Применение
  - `problem-solution-analysis` — Проблема → Решение → Анализ
  - `observe-imitate-create` — Наблюдение → Имитация → Создание

- **Формат контента** (ContentFormat):
  - `text_formulas` — для точных наук
  - `step_by_step` — для процедурных тем
  - `code_examples` — для программирования
  - `visual_diagrams` — для визуальных тем
  - `case_studies` — для бизнес-тем

#### Этап 2: Динамический конструктор
Строит уникальную структуру курса на основе анализа:
- Адаптивное введение (зависит от природы темы)
- Основной контент (зависит от сложности: 1-3, 4-6, 7-10)
- Примеры и применения (зависит от связей с индустрией)
- Практика (зависит от метода обучения)
- Проверка понимания
- Итоги

#### Этап 3: Умный генератор контента
Генерирует контент секция за секцией с задержками (обход rate limiting):
- Определяет тип темы (программирование, точные науки, гуманитарные)
- Адаптирует промпты под тип
- Использует внешние источники (arXiv, Open Library)

---

## 3. Система промптов (`lib/ai/prompts.ts`)

### 3.1 Основные системные промпты

| Промпт | Назначение | Особенности |
|--------|------------|-------------|
| `graphGeneration` | Генерация структуры курса | 8-15 тем, зависимости, сложность |
| `diagnosis` | Диагностика уровня знаний | Вопросы с вариантами ответов |
| `theory` | Генерация теории | Мин. 3000 слов, интерактивные блоки |
| `taskGeneration` | Генерация заданий | Прогрессия сложности, разные типы |
| `codeReview` | Проверка кода | Обратная связь, не готовое решение |
| `chat` | AI-репетитор | Generative UI компоненты |

### 3.2 Generative UI в чате

AI может генерировать интерактивные компоненты:

```json
{"type":"quiz","data":{"question":"?","options":["A","B"],"correctIndex":0}}
{"type":"comparison","data":{"title":"Сравнение","headers":["A","B"],"rows":[...]}}
{"type":"code","data":{"language":"python","code":"print('Hello')"}}
{"type":"flowchart","data":{"nodes":[...],"connections":[...]}}
{"type":"info","data":{"title":"Важно","content":"...","icon":"tip"}}
{"type":"steps","data":{"steps":[{"title":"Шаг 1","description":"..."}]}}
{"type":"progress","data":{"items":[{"label":"Python","value":75}]}}
```

---

## 4. API Endpoints

### 4.1 Цели и курсы

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/api/goals` | Список курсов пользователя |
| POST | `/api/goals` | Создание курса с AI-генерацией графа знаний |
| GET | `/api/goals/[id]` | Детали курса |
| PUT | `/api/goals/[id]` | Обновление курса |
| DELETE | `/api/goals/[id]` | Удаление курса |

### 4.2 Уроки и темы

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/api/topics/[id]/lesson?type=theory` | Получение теории (AI-генерация) |
| GET | `/api/topics/[id]/lesson?type=practice` | Получение практики (AI-генерация) |
| POST | `/api/topics/[id]/lesson` | Отметка о прохождении теории |
| POST | `/api/topics/[id]/submit` | Отправка ответа на задание |

### 4.3 Статистика и геймификация

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/api/stats` | Статистика пользователя (XP, streak, уровень) |
| GET | `/api/review` | Карточки для повторения (Spaced Repetition) |
| POST | `/api/review/[id]` | Обновление карточки после повторения |

### 4.4 AI-чат

| Метод | Endpoint | Описание |
|-------|----------|----------|
| POST | `/api/chat` | Отправка сообщения AI-репетитору |
| GET | `/api/chat/history` | История чата |

### 4.5 Диагностика

| Метод | Endpoint | Описание |
|-------|----------|----------|
| POST | `/api/diagnosis` | Диагностика уровня знаний |

---

## 5. Модель данных (Prisma Schema)

### 5.1 Пользователи

```prisma
model User {
  id               String    @id @default(cuid())
  email            String    @unique
  name             String?
  avatar           String?
  googleId         String?   @unique
  preferredStyle   LearningStyle @default(BALANCED)
  dailyGoalMinutes Int       @default(30)
  timezone         String    @default("Europe/Moscow")
  goals            Goal[]
  progress         TopicProgress[]
  reviews          ReviewCard[]
  stats            UserStats?
  achievements     Achievement[]
  chatMessages     ChatMessage[]
}

model UserStats {
  currentStreak   Int       @default(0)
  longestStreak   Int       @default(0)
  totalMinutes    Int       @default(0)
  totalLessons    Int       @default(0)
  totalTasks      Int       @default(0)
  totalXP         Int       @default(0)
  level           Int       @default(1)
}
```

### 5.2 Курсы и темы

```prisma
model Goal {
  id          String     @id @default(cuid())
  userId      String
  title       String
  skill       String
  description String?
  targetDate  DateTime?
  status      GoalStatus @default(ACTIVE)
  topics      Topic[]
  roadmap     Json?
}

model Topic {
  id               String     @id @default(cuid())
  goalId           String
  slug             String
  name             String
  description      String?
  icon             String?
  estimatedMinutes Int        @default(30)
  difficulty       Difficulty @default(MEDIUM)
  order            Int        @default(0)
  prerequisiteIds  String[]   @default([])
  lessons          Lesson[]
  progress         TopicProgress[]
}
```

### 5.3 Уроки и прогресс

```prisma
model Lesson {
  id         String     @id @default(cuid())
  topicId    String
  userId     String?
  type       LessonType // THEORY, PRACTICE, QUIZ, CODING
  title      String?
  content    Json       // Сгенерированный AI контент
  difficulty Difficulty
  hints      String[]
  solution   String?
}

model TopicProgress {
  userId           String
  topicId          String
  status           TopicStatus // LOCKED, AVAILABLE, IN_PROGRESS, COMPLETED
  masteryLevel     Int         @default(0)
  theoryCompleted  Boolean     @default(false)
  practiceScore    Int?
  timeSpentMinutes Int         @default(0)
}
```

### 5.4 Spaced Repetition

```prisma
model ReviewCard {
  id             String   @id @default(cuid())
  userId         String
  front          String   // Вопрос
  back           String   // Ответ
  topicSlug      String
  easeFactor     Float    @default(2.5)  // SM-2 алгоритм
  interval       Int      @default(1)    // Дни до повторения
  repetitions    Int      @default(0)
  nextReviewDate DateTime @default(now())
}
```

### 5.5 Достижения

```prisma
enum AchievementType {
  FIRST_LESSON, FIRST_TOPIC, FIRST_GOAL
  STREAK_3, STREAK_7, STREAK_30, STREAK_100
  TASKS_10, TASKS_50, TASKS_100
  CARDS_10, CARDS_50, CARDS_100
  PERFECT_QUIZ, SPEED_LEARNER
  NIGHT_OWL, EARLY_BIRD
  XP_100, XP_500, XP_1000, XP_5000
  LEVEL_5, LEVEL_10
  DAILY_CHALLENGE_7
}
```

---

## 6. Типы практических заданий

### 6.1 Структура задания

```typescript
interface Task {
  id: number
  type: 'single' | 'multiple' | 'text' | 'number' | 'matching' | 'code'
  difficulty: 'easy' | 'medium' | 'hard'
  question: string
  options?: string[]           // Для single/multiple
  correctAnswer?: number       // Для single/number
  correctAnswers?: number[]    // Для multiple
  leftItems?: string[]         // Для matching
  rightItems?: string[]        // Для matching
  correctPairs?: [number, number][]  // Для matching
  language?: string            // Для code
  starterCode?: string         // Для code
  testCases?: { input: string; expected: string }[]  // Для code
  solution?: string            // Для code
  tolerance?: number           // Для number (погрешность)
  hint?: string
  explanation: string
}
```

### 6.2 Алгоритмы проверки

| Тип | Алгоритм проверки |
|-----|-------------------|
| single | Сравнение индекса выбранного варианта |
| multiple | Проверка всех выбранных индексов |
| text | Нормализация + Levenshtein distance (допуск опечаток до 20%) |
| number | Проверка с tolerance (погрешность) |
| matching | Проверка всех пар соответствий |
| code | Отправка в Groq API для семантической проверки |

---

## 7. Инновационные технологии

### 7.1 Адаптивное обучение (Adaptive Learning)
- AI анализирует результаты пользователя
- Подстраивает сложность материала
- При низком проценте правильных ответов рекомендует повторение

### 7.2 Интервальное повторение (Spaced Repetition)
Алгоритм SM-2:
```
EF' = EF + (0.1 - (5 - q) * (0.08 + (5 - q) * 0.02))
где q — качество ответа (0-5)
EF — easeFactor (начальное 2.5)
```

Интервалы:
- Первое повторение: 1 день
- Второе: 6 дней
- Далее: interval * EF

### 7.3 Геймификация
- **XP**: очки за задания (10-50 XP)
- **Уровни**: 1-100 (формула: level = floor(sqrt(totalXP / 100)))
- **Streak**: серия дней обучения
- **Достижения**: 23 типа бейджей
- **Ранги**: Новичок → Ученик → Эксперт → Мастер → Легенда

### 7.4 AI-генерация контента
- Персонализированная теория (3000+ слов)
- Адаптивные задания под тип темы
- Интерактивные элементы в теории
- AI-проверка кода

### 7.5 Мультимодальные задания
- 6 типов заданий
- Drag & Drop для matching
- Код-редактор с подсветкой
- AI-подсказки и объяснения

---

## 8. Блок-схема создания курса

```
┌─────────────────────────────────────────────────────────────────┐
│                    ПОЛЬЗОВАТЕЛЬ                                  │
│              Вводит тему: "Python ООП"                          │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  POST /api/goals                                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  1. Получение контекста из внешних источников           │   │
│  │     - arXiv API (научные статьи)                        │   │
│  │     - Open Library API (книги)                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                         │                                       │
│                         ▼                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  2. AI генерация структуры курса                        │   │
│  │     Groq API → LLaMA 3.3-70B                            │   │
│  │     Промпт: getGraphGenerationPrompt()                  │   │
│  │     Результат: 8-15 тем с зависимостями                 │   │
│  └─────────────────────────────────────────────────────────┘   │
│                         │                                       │
│                         ▼                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  3. Сохранение в PostgreSQL                             │   │
│  │     - Goal (курс)                                       │   │
│  │     - Topics (темы)                                     │   │
│  │     - TopicProgress (прогресс = AVAILABLE)              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                         │                                       │
│                         ▼                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  4. Генерация 50 карточек для повторения                │   │
│  │     Groq API → ReviewCard[]                             │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  ИЗУЧЕНИЕ ТЕМЫ                                                  │
│                                                                 │
│  GET /api/topics/[id]/lesson?type=theory                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  AI Agent System (если USE_AI_AGENT=true)               │   │
│  │                                                         │   │
│  │  Этап 1: analyzeTopicDeep()                            │   │
│  │  → Определение природы темы                             │   │
│  │  → Выбор метода обучения                                │   │
│  │  → Определение формата контента                         │   │
│  │                                                         │   │
│  │  Этап 2: buildCourseStructure()                        │   │
│  │  → Динамическое построение секций                       │   │
│  │  → Адаптация под тип темы                               │   │
│  │                                                         │   │
│  │  Этап 3: generateFullLessonContent()                   │   │
│  │  → Генерация секция за секцией                          │   │
│  │  → Задержки между запросами (rate limiting)             │   │
│  └─────────────────────────────────────────────────────────┘   │
│                         │                                       │
│                         ▼                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Сохранение урока в БД                                  │   │
│  │  Lesson { type: THEORY, content: { markdown: "..." } }  │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  ПРАКТИКА                                                       │
│                                                                 │
│  GET /api/topics/[id]/lesson?type=practice                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  generatePracticeFromTheory()                           │   │
│  │                                                         │   │
│  │  1. Определение типа темы:                              │   │
│  │     - isProgramming → code задания                      │   │
│  │     - isPhysics/isChemistry → number задания            │   │
│  │     - isMath → number задания                           │   │
│  │     - isLanguage → text/single задания                  │   │
│  │                                                         │   │
│  │  2. Генерация 15-20 заданий:                            │   │
│  │     - 5 easy                                            │   │
│  │     - 6 medium                                          │   │
│  │     - 4 hard                                            │   │
│  │                                                         │   │
│  │  3. Сортировка по сложности                             │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  ПРОВЕРКА ОТВЕТОВ (StepikTask.tsx)                             │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  checkAnswer()                                          │   │
│  │                                                         │   │
│  │  single: selectedSingle === correctAnswer               │   │
│  │  multiple: selectedMultiple ⊆ correctAnswers            │   │
│  │  text: normalize() + levenshtein() ≤ 20%               │   │
│  │  number: |userNum - correctNum| ≤ tolerance            │   │
│  │  matching: all pairs match                              │   │
│  │  code: POST /api/chat → AI проверка                    │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  ОБНОВЛЕНИЕ ПРОГРЕССА                                          │
│                                                                 │
│  POST /api/topics/[id]/submit                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  - Начисление XP (10-50 за задание)                     │   │
│  │  - Обновление masteryLevel                              │   │
│  │  - Проверка streak                                      │   │
│  │  - Проверка достижений                                  │   │
│  │  - Обновление статистики                                │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 9. Переменные окружения

```env
# База данных
DATABASE_URL="postgresql://..."

# Groq API
GROQ_API_KEY="gsk_..."

# Supabase (для прокси)
NEXT_PUBLIC_SUPABASE_URL="https://..."
NEXT_PUBLIC_SUPABASE_ANON_KEY="..."

# Флаги
USE_AI_AGENT="true"        # Использовать AI Agent System
USE_DIRECT_GROQ="false"    # Прямое подключение к Groq (без прокси)
VERCEL="1"                 # Автоматически на Vercel
```

---

## 10. Безопасность

- JWT-токены для аутентификации
- Middleware для защиты роутов (`middleware.ts`)
- Валидация входных данных на API
- Rate limiting через Groq API
- Санитизация пользовательского ввода
- CORS настройки
- Защита от XSS в Markdown рендеринге
